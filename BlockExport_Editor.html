<!-- 
  @description: CodeB + DIY 병합
  @date: 2021.09.08
  @modifier: 정지현
  @did:
    - DIY 참고하여 리소스 파일 정리 (2000 Lines -> 약 800 Lines)
  @TODO:
    - 주석 정리 및 코드 정리 등의 리팩토링 전반
-->

<!DOCTYPE html>
<html>

<head profile="http://www.w3.org/2005/10/profile">

  <link rel="icon" type="image/png" href="http://example.com/myicon.png">

  <meta charset="utf-8" />
  <!-- 
    viewport(반응형 웹) :  여러 디스플레이 통해 접속 가능 
    width=device-width : 페이지 너비를 기기의 스크린 너비로 설정
    initial-scale=1 : 페이지 로딩 시 원래 크기를 사용 (확대, 축소 되지 않음)
  -->
  <!--for messagebox-->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CodeB</title>

  <!-- #####################################################################################################  -->
  <!-- ******************************               CDN                       ******************************* -->
  <!-- #####################################################################################################  -->
  <!-- jquery -->

  
  <script type="text/javascript" src="/js/cdn_script.js"></script>
  <script type="text/javascript" src="/js/css_script.js"></script>
  <script type="text/javascript" src="/js/resources_script.js"></script>
  <script type="text/javascript" src="/js/blocks_script.js"></script>

  <script>setCookie("download_block", "", 1);</script>

  <!-- 하단 변수가 없는 경우 맷플롯립에서 문제가 발생함 삭제 및 주석 금지 -->
  <script>var DL_Gra = 0;</script>
</head>

<body>
  <script src="/js/utils/blockCodes.js"></script>

  <!-- 언어 패키지, 카테고리 색상 -->
  <!-- 2020-12-05 양승국 동적 변경을 위해 head -> body로 옮김-->
  <script id="lan" src="/js/blockly/msg/js/ko.js"></script>

  <div class="libraryDiv modal fade" id="libraryDiv">
    <div class="modal-dialog"></div>
    <div class="header" style="width:96%">
      <img src="/lib_logos/Library_Title.png" style="margin: 5px;">
      <hr style="border: solid 1px white;
    width: 72%;
    display: inline-block;
    margin-bottom: -5px;">
      <img id="modal_close_btn" class="large close icon" src="/lib_logos/close.png" data-dismiss="modal"
        aria-label="Close">
    </div>
    <!-- 카드 -->
    <div class="libraryGrid">
      <!-- 컬럼 -->
      <div class="column">
        <!-- 카드 상세 -->
        <div class="ui fluid">
          <div class="libraryimage">
            <img src="/lib_logos/scikit-image.png">
          </div>
          <div class="content">
            <a class="header">이미지 프로세싱</a>
            <div class="description">
              다양한 이미지를 처리할 수 있는 Scikit-Image가 포함된 라이브러리입니다.<br>
            </div>
          </div>
          <div id="image_processing_import_btn" data-id="3" data-is-imported="0" class="importBtn">
            추가
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="loading" class="ui segment loadingSetting">
    <div id="loading_dimmer" class="ui active dimmer">
      <div id="loading_inner_text" class="ui huge text loader"><b>초기 설정 중...</b><br><br>네트워크 환경에 따라 시간이 다소 소요될
        수
        있습니다.</div>

    </div>
    <!-- 그래프 사이드바 start-->
    <aside id="sidebar">
      <!-- 그래프 사이드바 닫기 버튼 -->
      <div class="sidebar">
        <button id="runButton2" class="btn btn-outline-success btn-sm mr-1" onclick="runButton();"
          style="display:none;">실행</button>
        <!-- 실행 로딩 중 -->
        <div id="loading_image2" style="display: inline-block;">
          <object type="image/svg+xml" data="Rolling-1s-30px.svg"></object>
        </div>
        <button id="button_close" class="btn btn-outline-primary btn-sm mr-1" onclick="sidebar_toggle();">닫기</button>
        <button id="button_clear" class="btn btn-outline-danger btn-sm" onclick="csv_clear();">지우기</button>
        <button id="button_reset" class="btn btn-outline-danger btn-sm" onclick="sidebar_clear();">전체 초기화</button>
      </div>

      <div id=graph></div>

      <div id=graph1 style="height:500px; width:900px;"><img id="pyplotfigure" /></div>
      <!-- <div id=graph2 style="height: 300px;"></div> 
      <div id=graph3 style="height: 300px;"></div>-->
      <div id="csv_show"></div>
    </aside>
    <!-- 그래프 사이드바 end-->

    <div class="container-fluid">
      <!-- nav -->
      <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #f4f6ff;">

        <!-- a -->
        <a class="navbar-brand" href="/"><img src="/logo2-2.png" /></a>

        <!-- 왼쪽 구역-->
        <div class="btnDiv">
          <div class="d-flex flex-wrap text-white">

            <!-- 파일 열기 -->
            <div class="div-wrap-pull-localBlock">
              <input type="file" id="file" class="" accept="text/xml"
                onchange="loadBlock(); this.value=null;return false;">
              <label for="file">
                <span class="blockFileLoad">블록파일 가져오기</span>
                <span class="codebBtn"><img src="/search.png" alt=""></span>
              </label>
              <!-- <label class="custom-file-label mr-1" for="file">파일열기</label> -->
            </div>

            <!-- 블록 지우기 -->
            <span id="button_block_del" class="codebBtn" onClick="clearBlock();">
              <span class="codebBtnIcon"><img src="/reset.png" alt="초기화"></span>
              <span class="codebBtnText">초기화</span>

            </span>
            <!-- 삭제하지 말아주세요 LTI -->

            <!-- 블록 저장 -->
            <!-- <c:if test="${isChallenge != 1}"> -->
            <span id="button_block_save" class="codebBtn codebBtn-mobile-size" onclick="saveBlock()">
              <span class="codebBtnIcon"><img src="/prjSave.png" alt="블록 저장"></span>
              <span class="codebBtnText">블록 저장</span>
            </span>
            <!-- </c:if> -->

            <!-- 블록 탭 -->
            <div class="btn-group" role="group">
              <span class="codebBtn" onclick="visibleBlock()"><span class="codebBtnText">블럭</span></span>
              <span class="codebBtn" onclick="visibleAll()"><span class="codebBtnText">블럭 + 코드</span></span>
              <span class="codebBtn" onclick="visibleCode()"><span class="codebBtnText">코드</span></span>
            </div>

          </div>

          <!-- 해상도 디바이더 -->
          <div class="div-editor-divider"></div>

          <!-- 오른쪽 구역 -->
          <div class="d-flex flex-wrap text-white">
            <!-- 폰트크기변환 -->
            <!-- <select id="fontsize" class="form-control col-md-2 mt-2 ml-1">
<option id = "none" value="none" selected>Font Size</option>
<option id = "15" value="15">15</option>
<option id = "20" value="20">20</option>
<option id = "25" value="25">25</option>
<option id = "30" value="30">30</option>
</select> -->

            <!-- 실행 버튼 -->
            <!-- <input id="runButton1" type="button" class="btn btn-outline-success btn-sm mr-1" style="display:none;"
onClick="runButton()" value="실행" /> 다시 원상 복귀 style="display:none;" [on click 전] -->
            <!-- 실행 로딩 중 -->
            <span id="loading_icon" class="loadingIcon">
              <i id="loading_image1" class="big spinner loading icon loadingPosition"></i>
              <p id="loading_text">불러오는 중...</p>
            </span>

            <!-- 문제 보기 프로토 -->
            <!-- <c:if test="${isChallenge == 1}">
            <span id="sidebar_asgn" class="codebBtn">
              <span class="codebBtnIcon"><img src="/assignment.png" alt="도움말"></span>
              <span class="codebBtnText">문제 보기</span>
            </span>
          </c:if> -->
            <!-- 
          <span id="sidebar_help" class="codebBtn" onclick="showTutorial()">
            <span class="codebBtnIcon"><img src="/help.png" alt="도움말"></span>
            <span class="codebBtnText">도움말</span>
          </span> -->

            <!-- 기존 로딩 svg -->
            <!-- <div id="loading_image1"><object type="image/svg+xml" data="/Rolling-1s-30px.svg"></object>
    </div> -->

            <!-- 결과 버튼 -->

            <!-- <input id="button_console_clear" type="button" class="btn btn-outline-secondary btn-sm mr-1" onClick=clear_result();
value="결과 지우기" /> -->

            <!-- 저장 버튼 -->
            <!-- <input id="button_code_save" type="button" class="btn btn-outline-secondary btn-sm mr-1" onClick=file_save();
value="코드저장" /> -->

            <!-- Button trigger modal 
<button id = "button_paint" type="button" class="btn btn-outline-secondary btn-sm mr-1" data-toggle="modal"
data-target="#staticBackdrop">그림판</button>-->

            <!-- Modal -->
            <div class="modal fade" id="staticBackdrop" data-backdrop="static" data-keyboard="false" tabindex="-1"
              aria-labelledby="staticBackdropLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">그림판</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>

                  <div class="modal-body">
                    <!-- canvas -->
                    <canvas id="canvas" class="canvas" width="300" height="300"></canvas>
                  </div>

                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary mr-1" data-dismiss="modal">취소</button>
                    <!-- reset button -->
                    <form>
                      <input type="button" id="reset" class="btn btn-danger mr-1" value="다시 그리기">
                    </form>
                    <a id="download" download="image.png"><button type="button" class="btn btn-primary"
                        onClick="canvas_save()">그림 저장</button></a>
                    <input type="file" id="btn_upload" name="btn_upload" style="display: none;" />
                  </div>
                </div>
              </div>
            </div>

            <span id="button_block_save" class="codebBtn" onclick="file_save();">
              <span class="codebBtnIcon"><img src="/prjSave.png" alt="코드 저장"></span>
              <span class="codebBtnText">코드 저장</span>
            </span>
            <!-- 모달 -->

            <!-- 그래프 버튼 -->
            <!-- <input id="sidebar_button" type="button" class="btn btn-outline-primary btn-sm" value="그래프"
onclick="sidebar_toggle()" /> -->
            <span id="sidebar_add_libs" class="codebBtn" data-toggle="modal" data-target="#libraryDiv">
              <span class=" codebBtnIcon"><img src="/library.png" alt="라이브러리 추가"></span>
              <span class="codebBtnText">라이브러리 추가</span>
            </span>
            <span id="sidebar_graph" class="codebBtn" onclick="sidebar_toggle()">
              <span class="codebBtnIcon"><img src="/graph.png" alt="그래프"></span>
              <span class="codebBtnText">그래프</span>
            </span>

          <!-- 사용한 파일 저장 --> 
          <span id="button_block_save" class="codebBtn" onclick="file_use_Download();">
            <!-- <i class="sign out icon"></i> -->
            <span class="codebBtnIcon">
              <i class="save icon"></i>
            </span>
            <span class="codebBtnText">사용한 파일 저장</span>
          </span>

            <span id="exit_button" class="codebBtn" onclick="handleClickMenuToggle();">
              <!-- <i class="sign out icon"></i> -->
              <span class="codebBtnIcon"><img src="/settings.png" alt="나가기" style="width: 15px;"></span>
              <span class="codebBtnText">설정</span>
            </span>


            <!-- 라이브러리 추가 -->
            <!-- Modal -->
            <div class="modal fade" id="libraryBox" data-backdrop="static" data-keyboard="false" tabindex="-1"
              aria-labelledby="libraryBoxLabel" aria-hidden="true">
              <div class="modal-dialog" style="max-width: 50%;">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="libraryBoxLabel">라이브러리 추가</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>

                  <div class="modal-body">
                    <table class="libListBox">
                      <colgroup>
                        <col width="15%" />
                        <col width="70%" />
                        <col width="15%" />
                      </colgroup>

                    </table>
                    <!-- canvas -->
                  </div>


                </div>
              </div>
            </div>
            <!-- 모달 -->
            <!-- 2020-12-05 양승국 언어변경을 위해 생성-->
            <!--언어변환 -->
            <!-- <select id="language" class="form-control col-md-2 mt-2 ml-1">
<option id = "ko" value="kor">Ko</option>
<option id = "en" value="eng">en</option>
</select> -->

          </div> <!-- 오른쪽 구역 -->
        </div>
      </nav>

      <!--####### 은선 - tab 추가 #######-->
	<!-- tab style-->

	<!--tab 목록-->
	<!-- <div class="container"> -->
	<!-- 탭 메뉴 -->
	<div id="tab_unm" class="tabs">
		<ul class="tab">
			<li class="tab-link current" data-tab="tab-1" style="margin-left: 10px;">
				<a class="tab" id='tab_1'>Tab - 1</a>
			</li>
	
			<li class="tab-link" data-tab="tab-2">
				<a class="tab" id='tab_2'>Tab - 2</a>
			</li>
	
			<li class="tab-link" data-tab="tab-3">
				<a class="tab" id='tab_3'>Tab - 3</a>
			</li>
		</ul>
	</div>
<script>
	//왼쪽 스크립트
	$(document).ready(function () {

		var tab_id = 0;

		$('ul.tab li').click(function () {
			tab_id = $(this).attr('data-tab');

			$('ul.tab li').removeClass('current');
			$('.tab-content').removeClass('current');

			$(this).addClass('current');
			$("#" + tab_id).addClass('current');

			console.log(tab_id);
		})
	});
</script>

      <!-- 하단 내용 -->
      <div id="bottomDiv">

        <!-- 블럭 나오는 부분(왼쪽) -->
        <div id="blocklyDiv" class="borderR">
          <div id="tab-1" class="tab-content current">
            <div id="blocklyDiv1" style="height: calc(100vh - 90px);">
              <div class="windowTitle" id="windowBlockTitle">
                블록(Block)
                <div class="workspaceBtns">
                  <span class="workspaceFocus" onclick="workspaceFocusEvent();"></span>
                  <span class="workspacePlus" onclick="workspaceMinusEvent();"></span>
                  <span class="workspaceMinus" onclick="workspacePlusEvent();"></span>
                </div>
              </div>
            </div>
          </div>
      
          <div id="tab-2" class="tab-content">
            <div id="blocklyDiv2" style="height: calc(100vh - 90px);">
              <div class="windowTitle" id="windowBlockTitle">
                블록(Block)
                <div class="workspaceBtns">
                  <span class="workspaceFocus" onclick="workspaceFocusEvent();"></span>
                  <span class="workspacePlus" onclick="workspaceMinusEvent();"></span>
                  <span class="workspaceMinus" onclick="workspacePlusEvent();"></span>
                </div>
              </div>
            </div>
          </div>
      
          <div id="tab-3" class="tab-content">
            <div id="blocklyDiv3" style="height: calc(100vh - 90px);">
              <div class="windowTitle" id="windowBlockTitle">
                블록(Block)
                <div class="workspaceBtns">
                  <span class="workspaceFocus" onclick="workspaceFocusEvent();"></span>
                  <span class="workspacePlus" onclick="workspaceMinusEvent();"></span>
                  <span class="workspaceMinus" onclick="workspacePlusEvent();"></span>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- 블럭-코드 스플릿 바 -->
        <div class="gutter-col gutter-col-block-code"></div>

        <!-- 오른쪽 -->
        <div id="codeDiv">
          <div id="codeDiv1" class="borderR">
            <div class="card shadow-sm splitDiv">
              <div class="text-white">
                <div class="windowTitle" id="code">
                  코드(Code)
                  <button id="btn_block_code" onclick="toggleBlockCode();" class="ui inverted green button">블록코드
                    On</button>
                </div>
              </div>
              <div class="splitDiv" style="position: relative; height: calc(100% - 57px);">
                <div id="pyCodeEditor" class="splitDiv"></div>
                <div id="asyncCodeEditor" class="splitDiv"></div>
                <div id="jsCodeEditor" class="splitDiv"></div>
              </div>
            </div>
          </div>

          <!-- 코드-콘솔 스플릿 바 -->
          <div class="gutter-row gutter-row-code-console"></div>
          <div class='gutter-col gutter-col-code-console'></div>

          <!-- console -->
          <div id="codeDiv2" class="borderR">
            <div class="card mb-6 mt-6 shadow-sm splitDiv">
              <div class="text-white">
                <div class="windowTitle" id="console">
                  <span alt="실행버튼" id="runButton1"></span>
                  <span alt="지우기" id="button_console_clear" onclick="clear_result();"></span>
                  콘솔(Console)
                </div>
              </div>
              </textarea>
              <textarea id="exeArea" class="form-control splitDiv" readonly style="resize: none;"></textarea>
            </div>
          </div>
        </div> <!-- 오른쪽 -->
      </div> <!-- 하단 -->

      <!-- camera-->
      <!--
<video id="gum-local" autoplay playsinline></video>
<button id="showVideo">Open camera</button>
-->
    </div> <!-- container -->

    <script src="/js/utils/codeMirror.js"></script>
    <script src="/js/utils/basicFunctions.js"></script>
    <script src="/js/utils/blockFunctions.js"></script>

    <!-- Toolbox 정의 -->

    <script>
      	// (Workspace = 블록배치하는 공간) 블록이 나타나는 부분
	let Workspace1 = Blockly.inject(
	  "blocklyDiv1", {
	  toolbox: toolbox, // 툴박스  보이기 
	  grid: // 그리드 보이기 
	  {
		spacing: 0,
		length: 3,
		colour: '#ccc',
		snap: true
	  },
	  zoom: // 줌 기능 3단계 변경
	  {
		controls: true,
		wheel: true,
		startScale: 1.0,
		maxScale: 3,
		minScale: 0.3,
		scaleSpeed: 1.2,
		//pinch: true
	  },
	  trashcan: true, // 휴지통
	  renderer: "zelos" // 제로스 테마
	}
	);
	Workspace1.addChangeListener(codeUpdate);  // 코드 갱신하기 메소드
	Workspace1.addChangeListener(whenSelected);// 선택 되었을 때 메소드
	
	let Workspace2 = Blockly.inject(
	  "blocklyDiv2", {
	  toolbox: toolbox, // 툴박스  보이기 
	  grid: // 그리드 보이기 
	  {
		spacing: 0,
		length: 3,
		colour: '#ccc',
		snap: true
	  },
	  zoom: // 줌 기능 3단계 변경
	  {
		controls: true,
		wheel: true,
		startScale: 1.0,
		maxScale: 3,
		minScale: 0.3,
		scaleSpeed: 1.2,
		//pinch: true
	  },
	  trashcan: true, // 휴지통
	  renderer: "zelos" // 제로스 테마
	}
	);
	Workspace2.addChangeListener(codeUpdate);  // 코드 갱신하기 메소드
	Workspace2.addChangeListener(whenSelected);// 선택 되었을 때 메소드
	
	let Workspace3 = Blockly.inject(
	  "blocklyDiv3", {
	  toolbox: toolbox, // 툴박스  보이기 
	  grid: // 그리드 보이기 
	  {
		spacing: 0,
		length: 3,
		colour: '#ccc',
		snap: true
	  },
	  zoom: // 줌 기능 3단계 변경
	  {
		controls: true,
		wheel: true,
		startScale: 1.0,
		maxScale: 3,
		minScale: 0.3,
		scaleSpeed: 1.2,
		//pinch: true
	  },
	  trashcan: true, // 휴지통
	  renderer: "zelos" // 제로스 테마
	}
	);
	Workspace3.addChangeListener(codeUpdate);  // 코드 갱신하기 메소드
	Workspace3.addChangeListener(whenSelected);// 선택 되었을 때 메소드

      Blockly.FieldTextInput.prototype.maxDisplayLength = 100;
      let isImportLoading = 0;

      // var projectType = 0;
      // <c:if test="${not empty projectType}">
      //   projectType = ${projectType}
      // </c:if>

      // Matplotlib 에러를 방지하기 위한 Flag 변수
      var flagMatplotlibImport = 0;

      //  코드 실행
      function beforeRun() {
        showCodeLoading();
        setTimeout(() => {
          runButton()
        }, 300);
      }

      // 사이드 바에 따라 페이지 크기 조절
      function setPageSize(sidebarFlag) {
        if (sidebarFlag == 0) {
          $(".pusher").width($(document).width());
        } else {
          $(".pusher").width($(document).width() - $(".ui.labeled.icon.sidebar").width());
        }
      }

      // 사이드바 창 닫기
      function closeSideBar() {
        $(".ui.labeled.icon.sidebar").sidebar("hide");
      }

      $(document).ready(function () {
        $("#runButton1").on('mouseup', function () {
          showCodeLoading();
          setTimeout(() => {
            runButton()
          }, 300);
        })

        var sidebarFlag = 0;
        $(".ui.labeled.icon.sidebar").sidebar("setting", "dimPage", false); // Dim Out
        $(".ui.labeled.icon.sidebar").sidebar("setting", "closable", false); // 마우스 클릭 시 No closing
        $(".ui.labeled.icon.sidebar").sidebar("setting", "transition", "overlay"); // 오버레이

        $("#sidebar_asgn").click(function () {
          if (sidebarFlag == 0) {
            //setPageSize(sidebarFlag);
            sidebarFlag = 1;
          } else {
            //setPageSize(sidebarFlag);
            sidebarFlag = 0;
          }
          $(".ui.labeled.icon.sidebar").sidebar("toggle");
        })

        // 데이터 사이언스

        // 라이브러리 모달창 열기
        $("#sidebar_add_libs").on("click", function () {
          $('#libraryDiv').modal({ backdrop: 'static' });
        })
      })


    </script>

    <script>

      // TODO: recordBlockStatusEvent 이벤트 각 Workspace에 적용될 수 있도록 로직 수정해야 함.
      // 블록 생성 및 삭제를 기록할 전역 배열
      var recordCreatedArr = [];
      var recordDeletedArr = [];

      var recordCreatedBlock = null;
      var recordSelectedBlock = null;
      var currentBlockType = null;

      function recordBlockStatusEvent(event) {
        var blockRecordJSON = null;

        if (event.type == "create") {
          recordCreatedBlock = workspace.getBlockById(event.blockId); // 현재 생성된 블록을 기록.
          currentBlockType = recordCreatedBlock.type; // 블록의 type(이름)을 기록
          // console.log("Created block : " + currentBlockType);
          recordCreatedArr.push(currentBlockType); // 사용자가 생성한 블록을 버퍼에 추가
        } else if (event.element == "click") {
          // 선택된 블록 기록
          recordSelectedBlock = workspace.getBlockById(event.blockId);
          currentBlockType = recordSelectedBlock.type;
          // console.log("Clicked block : " + currentBlockType);
        } else if (event.type == "delete") {
          recordDeletedArr.push(currentBlockType);
        }
        //console.log(recordDeletedArr);
        blockRecordJSON = JSON.stringify({ "create": recordCreatedArr, "delete": recordDeletedArr });
      }
      // workspace.addChangeListener(codeUpdate);  // 코드 갱신하기 메소드
      // workspace.addChangeListener(whenSelected);// 선택 되었을 때 메소드
      // workspace.addChangeListener(recordBlockStatusEvent);
    </script>

    <!-- pyodide 초기화 -->
    <script src="/js/utils/pyodide.js"></script>
    <script>
      //==================================
      // 블록을 실행했을 때 
      //==================================
      //새로운 실행방법
      function runButton() {

        // 그래프 위쪽 삭제
        $("#graph1").remove();
        $("#csv_show").before("<div id='graph1' style=\"height:500px; width:900;\"><img id='pyplotfigure' /></div>");
        // 그래프 위쪽 삭제

        // 그래프같은 이미지들을 싹다 잡아옴 plt.show()하면 바로 되는이유
        globalThis.iodide = {
          output: {
            element: (tagName) => {
              let outputPane = document.createElement(tagName);
              document.querySelector("#graph1").appendChild(outputPane);
              return outputPane;
            }
          }
        };

        Blockly.Python.addReservedWords('code');      // // 이 언어의 예약어 목록에 하나 이상의 단어를 추가한다.
        var code = pyEditor.getValue();               // py 코드미러의 값을 code로 저장
        Blockly.JavaScript.addReservedWords('code2'); // // 이 언어의 예약어 목록에 하나 이상의 단어를 추가한다.
        var code2 = jsEditor.getValue();              // js 코드미러의 값을 code2로 저장

        // 블록 코드 On/Off 에 따른 Flag에 따라 Code Editor로부터 가져오는 코드 분기
        flagBlockCode == 1 ? code = pyEditor.getValue() : code = asyncEditor.getValue();

        // 이 부분이 코드 싹다 잡아와서 출력
        // 실행했을때 그래프를 지우고 하기 위해
        // plt.cla - 클리어
        // plt.clf - figure클리어
        // os는 data폴더 mount 에러 임시로 해결하기 위해
        // 코드 실행 전 초기화

        pyodideReadyPromise.then(() => {
          pyodide.runPython(`
                    import sys
                    import os 
                    import io
                    import matplotlib.pyplot as plt
                    plt.cla()
                    plt.clf()
                    sys.stdout = io.StringIO()
                    `)
          pyodide.runPythonAsync(`
import sys
import os 
import io
import matplotlib.pyplot as plt

# 그래프 그리려면 필요한 부분 start
from matplotlib.backends import backend_agg
if "pyodide" in sys.modules:
  from js import document, ImageData

def create_root_element1(self):
  div = document.createElement('div')
  document.querySelector("#graph1").appendChild(div)
  return div

f = plt.gcf()

#override create_root_element method of canvas by one of the functions above
f.canvas.create_root_element = create_root_element1.__get__(f.canvas, f.canvas.__class__)
f.canvas.show()
# 그래프 그리려면 필요한 부분 end

sys.stdout = io.StringIO()
                		`);
        });
        // 코드상 에러 구현
        if (code) {
          if (code.indexOf("os.chdir") != -1) {
            let current_path = pyodide.runPython(`os.getcwd()`); // 현재 경로 받아옴
            let dir_list = pyodide.runPython(`os.listdir()`); // 디렉토리 비교하기 위해
            let root_list = pyodide.runPython(`os.listdir('/')`);

            let start_index = code.indexOf("os.chdir(");
            let end_index = code.indexOf(")", start_index);

            let replace_str = code.substr(start_index, (end_index - (start_index - 1)))

            // 1. start_index부터 앞쪽으로 검색하여 개행이 어디 있는 지 확인하고, 몇번째 문자인지 변수에 저장
            let err_index = (start_index + 10) - (code.lastIndexOf("\n", start_index + 10) - 1);

            // 2. start_index부터 앞쪽으로 검색하여 개행이 몇개인지 파악하고, 몇번째 라인인지 확인
            let err_str = code.substr(0, start_index + 10);
            let err_line = err_str.match(/\n/g);
            if (err_line === null)
              err_line = 1;
            else
              err_line = err_str.match(/\n/g).length + 1;

            let err_dir = code.substr(start_index + 10, ((end_index - 2) - (start_index + 10 - 1)))

            let output_err = "Error: Traceback (most recent call last):"
            let output_err2 = "File \"/lib/python3.8/site-packages/pyodide/_base.py\", line 70, in eval_code"
            let output_err3 = "eval(compile(mod, \"<exec>\", mode=\"exec\"), ns, ns)"
            let output_err4 = "File \"<exec>\", line " + String(err_line) + ", in <module>"
            let output_err5 = "FileNotFoundError: [Errno 2] No such file or directory: "

            if (current_path.indexOf("/data") != -1) { // data 하위 디렉토리 모두 적용

              let dir_index;
              let bool_;

              for (dir_index = 0; dir_index < dir_list.length; dir_index++) {
                if (dir_list[dir_index] == err_dir || err_dir.indexOf('/') != -1 || err_dir.indexOf('../') != -1) {
                  bool_ = false;
                  break;
                } else if (err_dir == '..' || err_dir == '.') {
                  bool_ = false;
                  break;
                } else
                  bool_ = true;
              }

              if (dir_list.length == 0 && !(err_dir.indexOf('/') != -1 || err_dir.indexOf('../') != -1 || err_dir == '..' || err_dir == '.'))
                bool_ = true; // 디렉토리 내부가 비어 있을 때도 적용

              if (bool_ == true) {
                code = code.replace(code, '');
                //code = code.replace(replace_str, '"' + output_err + '"');
                code = "print('" + output_err + "')";
                code = code + ("\nprint(' " + output_err2 + "')");
                code = code + ("\nprint('  " + output_err3 + "')");
                code = code + ("\nprint(' " + output_err4 + "')");
                code = code + ('\nprint("' + output_err5 + "'" + err_dir + "'" + '")');
              };
            };
          };

          // 크롤링 req.text부분 처리
          if (code.indexOf("req.text") != -1) {
            code = code.replace("req.text", 'req');
          };
        };

        // 순차적 실행을 위해 놓은 코드 async, .then()
        async function runcode() {
          "use strict";
          // pyodide.globals.clear();
          await pyodideReadyPromise;
          var exe = document.getElementById('exeArea'); // 콘솔 창 ID가져옴
          try {
            exe.innerHTML = pyodide.runPython(code);
            let stdout = pyodide.runPython("sys.stdout.getvalue()"); // 결과값을 싹 받아줌
            exe.innerHTML = stdout;
          } catch (e) {
            if (e.toString().indexOf('FileNotFoundError') != -1 && code.toString().indexOf("pd.read_csv") != -1)
              exe.innerHTML = '파일 경로를 확인해주세요\n'
            else if (e.toString().indexOf('NameError') != -1 && code.toString().indexOf("pd.read_csv") != -1)
              exe.innerHTML = '파일 경로를 입력해주세요\n'
            else
              exe.innerHTML = e;
          } finally {
            $("#loading_dimmer").removeClass("active");
          }
        }

        // runcode끝내고 또 돌림, 테이블 형식 블록을위해 이걸 넣어줌
        runcode().then(() => {
          if (eval(code2) == undefined) {
            document.getElementById('exeArea').innerHTML += '\n';
          } else {
            console.log("error : javascript code error");
          }
        });
      }

    </script>
    <!-- csv를 테이블로 출력-->
    <script src="/js/utils/csvTablePrint.js"></script>
    <!-- 라이브러리 임포트 기능 테스트 -->
    <script src="/js/utils/libraryAdd.js"></script>
    <!-- prompt 설정 -->
    <script src="/js/utils/prompt.js"></script>
    <!-- 로컬 파일 오픈하기 -->
    <script src="/js/utils/localFileOpen.js"></script>
    <!-- 로컬로 파일 다운로드-->
    <script src="/js/utils/fileDownload.js"></script>


    <!-- 로컬 파일 오픈하기 -->
    <script>

    </script>

    <!-- 기본 블럭+코드 배치 -->
    <script>
	visibleAll()
	// 블록클리 리사이즈 이벤트 등록
	new ResizeSensor(jQuery('#blocklyDiv1'), function () {
	  Blockly.svgResize(Workspace1);
	});
	new ResizeSensor(jQuery('#blocklyDiv2'), function () {
	  Blockly.svgResize(Workspace2);
	});
	new ResizeSensor(jQuery('#blocklyDiv3'), function () {
	  Blockly.svgResize(Workspace3);
	});

  let eachTabCode;

  $('#tab_1').on('click',() => {
	console.log('tab1');
	eachTabCode = Blockly.Python.workspaceToCode(Workspace1);
	// console.log(testCode);
	pyEditor.setValue(eachTabCode);
  });
  $('#tab_2').on('click',() => {
	console.log('tab2');
	eachTabCode = Blockly.Python.workspaceToCode(Workspace2);
	// console.log(testCode);
	pyEditor.setValue(eachTabCode);
  });
  $('#tab_3').on('click',() => {
	  console.log('tab3')
    eachTabCode = Blockly.Python.workspaceToCode(Workspace3);
	pyEditor.setValue(eachTabCode);
  });
    </script>

    <!-- menu UI & menu setup -->
    <script src="/js/zeynep/config.js"></script>
    <!-- 기태 처리 (파일) 끝 20.12.29 ------------------------------------------------------------------------->

    <!-- 기태 추가(단축키)-->
<script>
	// 단축키 기능 추가 (ctrl + F11 실행 / ctrl + F10 결과 지우기 / ctrl + F9 블록 지우기 )
	var isCtrl;
	document.onkeyup = function (e) {
	  if (e.which == 17) {
		isCtrl = false;
	  }
	};
	document.onkeydown = function (e) {
	  if (e.which == 17) {
		isCtrl = true;
	  }
	  	  
	  if (e.which == 122 && isCtrl == true) {
		runButton();
	  }

	  if (e.which == 121 && isCtrl == true) {		
		clear_result();		
	  }

	  if (e.which == 120 && isCtrl == true) {			
		clearBlock();
	  }
	};
  </script>

</body>
<!--camera
<script src="/js/blockly/cam.js"></script>
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
-->

</html>